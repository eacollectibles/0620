<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trade-In Portal | EA Collectibles</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tesseract.js for OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  
  <style>
    :root {
      --gold: #d4af37;
      --gold-light: #f4e4a6;
      --gold-dark: #b8962e;
      --green: #4ade80;
      --green-dark: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --bg-dark: #0a0a0a;
      --bg-card: #0d0d12;
      --bg-input: rgba(255,255,255,0.03);
      --border: rgba(255,255,255,0.08);
      --border-gold: rgba(212, 175, 55, 0.3);
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.7);
      --text-muted: rgba(255,255,255,0.5);
      --font-display: 'Bebas Neue', Impact, sans-serif;
      --font-body: 'Inter', system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-body);
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* Header Bar */
    .ea-header {
      background: rgba(0,0,0,0.5);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .ea-logo {
      font-family: var(--font-display);
      font-size: 24px;
      letter-spacing: 2px;
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 50%, var(--gold) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .ea-badge {
      background: linear-gradient(135deg, var(--green-dark), var(--green));
      color: #0a0a0a;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px 80px;
    }

    /* Main Card */
    .main-card {
      background: var(--bg-card);
      border-radius: 24px;
      border: 1px solid var(--border-gold);
      overflow: hidden;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5), 0 0 100px rgba(212,175,55,0.05);
    }

    .card-header {
      background: linear-gradient(135deg, rgba(212,175,55,0.15) 0%, rgba(212,175,55,0.05) 100%);
      padding: 40px;
      text-align: center;
      border-bottom: 1px solid var(--border-gold);
    }

    .card-title {
      font-family: var(--font-display);
      font-size: 42px;
      letter-spacing: 3px;
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 50%, var(--gold) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .card-subtitle {
      color: var(--text-secondary);
      font-size: 16px;
    }

    .card-content {
      padding: 40px;
    }

    /* Progress Indicator */
    .progress-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 50px;
      position: relative;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
      z-index: 2;
    }

    .progress-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 22px;
      left: 60%;
      right: -40%;
      height: 2px;
      background: var(--border);
      z-index: 1;
    }

    .progress-step.active:not(:last-child)::after,
    .progress-step.completed:not(:last-child)::after {
      background: linear-gradient(90deg, var(--gold), var(--gold-dark));
    }

    .progress-circle {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--bg-input);
      border: 2px solid var(--border);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
      position: relative;
      z-index: 2;
    }

    .progress-step.active .progress-circle {
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      border-color: var(--gold);
      color: #0a0a0a;
      box-shadow: 0 0 25px rgba(212,175,55,0.4);
    }

    .progress-step.completed .progress-circle {
      background: linear-gradient(135deg, var(--green-dark), var(--green));
      border-color: var(--green);
      color: #0a0a0a;
    }

    .progress-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      text-align: center;
    }

    .progress-step.active .progress-label {
      color: var(--gold);
    }

    .progress-step.completed .progress-label {
      color: var(--green);
    }

    /* Step Sections */
    .step-section {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .step-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-title {
      font-size: 22px;
      font-weight: 700;
      margin: 0 0 24px 0;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-primary);
    }

    .step-title span:first-child {
      font-size: 28px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 18px 20px;
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 14px;
      font-size: 16px;
      color: var(--text-primary);
      transition: all 0.3s ease;
      font-family: var(--font-body);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--gold);
      background: rgba(212,175,55,0.05);
      box-shadow: 0 0 20px rgba(212,175,55,0.15);
    }

    /* Payout Options */
    .payout-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .payout-option {
      position: relative;
    }

    .payout-radio {
      position: absolute;
      opacity: 0;
    }

    .payout-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 24px 16px;
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
      text-align: center;
    }

    .payout-label .icon {
      font-size: 32px;
    }

    .payout-label .label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .payout-label .rate {
      font-size: 12px;
      color: var(--text-muted);
      background: rgba(255,255,255,0.05);
      padding: 4px 10px;
      border-radius: 10px;
    }

    .payout-option:hover .payout-label {
      border-color: var(--gold);
      transform: translateY(-3px);
    }

    .payout-radio:checked + .payout-label {
      border-color: var(--gold);
      background: linear-gradient(135deg, rgba(212,175,55,0.2) 0%, rgba(212,175,55,0.05) 100%);
      box-shadow: 0 10px 30px rgba(212,175,55,0.2);
    }

    .payout-radio:checked + .payout-label .label {
      color: var(--gold);
    }

    /* Info Box */
    .info-box {
      background: rgba(212,175,55,0.08);
      border: 1px solid var(--border-gold);
      border-radius: 14px;
      padding: 18px 20px;
      margin: 20px 0;
      display: flex;
      gap: 14px;
      align-items: flex-start;
    }

    .info-box .icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .info-box .text {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .info-box.warning {
      background: rgba(245,158,11,0.1);
      border-color: rgba(245,158,11,0.3);
    }

    .info-box.success {
      background: rgba(74,222,128,0.1);
      border-color: rgba(74,222,128,0.3);
    }

    /* Cards Section */
    .cards-section {
      background: rgba(255,255,255,0.02);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .cards-header {
      background: rgba(255,255,255,0.03);
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .cards-header h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .cards-header-actions {
      display: flex;
      gap: 10px;
    }

    .cards-list {
      padding: 20px;
      max-height: 50vh;
      overflow-y: auto;
    }

    .card-row {
      display: grid;
      grid-template-columns: 1fr 90px 50px;
      gap: 12px;
      align-items: center;
      padding: 16px;
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }

    .card-row:hover {
      border-color: var(--border-gold);
      background: rgba(212,175,55,0.03);
    }

    .card-input-container {
      position: relative;
    }

    .card-input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      color: var(--text-primary);
      transition: all 0.2s ease;
      font-family: var(--font-body);
    }

    .card-input::placeholder {
      color: var(--text-muted);
    }

    .card-input:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 15px rgba(212,175,55,0.15);
    }

    .card-input.confirmed {
      border-color: var(--green);
      background: rgba(74,222,128,0.08);
    }

    .card-input.not-found {
      border-color: var(--warning);
      background: rgba(245,158,11,0.08);
    }

    /* Search Suggestions */
    .search-suggestion {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: #15151f;
      border: 2px solid var(--gold);
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      z-index: 9999;
      overflow: hidden;
    }

    .option-item {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      background: transparent;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .option-item:hover {
      background: rgba(212,175,55,0.1);
    }

    .option-item:last-child {
      border-bottom: none;
    }

    /* Remove Button */
    .remove-btn {
      width: 42px;
      height: 42px;
      background: rgba(239,68,68,0.15);
      color: var(--error);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .remove-btn:hover {
      background: var(--error);
      color: white;
      border-color: var(--error);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 16px 28px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: var(--font-body);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      color: #0a0a0a;
      box-shadow: 0 5px 20px rgba(212,175,55,0.3);
    }

    .btn-primary:hover {
      box-shadow: 0 10px 30px rgba(212,175,55,0.4);
    }

    .btn-secondary {
      background: var(--bg-input);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--gold);
      color: var(--gold);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--green-dark), var(--green));
      color: #0a0a0a;
      box-shadow: 0 5px 20px rgba(74,222,128,0.3);
    }

    .btn-success:hover {
      box-shadow: 0 10px 30px rgba(74,222,128,0.4);
    }

    /* Navigation */
    .step-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 1px solid var(--border);
    }

    /* Estimate Results */
    .estimate-results {
      background: rgba(74,222,128,0.05);
      border: 1px solid rgba(74,222,128,0.2);
      border-radius: 16px;
      padding: 30px;
      margin: 30px 0;
      display: none;
    }

    .estimate-results.visible {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    .estimate-card {
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 18px 20px;
      margin-bottom: 12px;
      border: 1px solid var(--border);
    }

    .estimate-totals {
      background: rgba(212,175,55,0.1);
      border-radius: 14px;
      padding: 24px;
      border: 2px solid var(--border-gold);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      text-align: center;
      margin-top: 20px;
    }

    .total-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
    }

    .total-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .total-value.primary {
      color: var(--gold);
    }

    /* Success Section */
    .success-section {
      background: rgba(74,222,128,0.08);
      border: 2px solid var(--green);
      border-radius: 20px;
      padding: 50px 40px;
      text-align: center;
      display: none;
    }

    .success-section.visible {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    .success-icon {
      font-size: 80px;
      margin-bottom: 24px;
    }

    .success-title {
      font-family: var(--font-display);
      font-size: 36px;
      letter-spacing: 2px;
      color: var(--green);
      margin-bottom: 16px;
    }

    .success-message {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 30px;
    }

    .submission-id {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 18px;
      color: var(--gold);
    }

    /* Spinner */
    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 20px 16px 60px; }
      .card-content { padding: 24px 20px; }
      .card-header { padding: 30px 20px; }
      .card-title { font-size: 32px; }
      .card-row { grid-template-columns: 1fr; gap: 12px; }
      .card-row .form-input[name="cardQuantity"] { width: 100% !important; }
      .card-row .remove-btn { width: 100%; height: 44px; }
      .payout-options { grid-template-columns: 1fr; }
      .step-navigation { flex-direction: column; gap: 12px; }
      .btn { width: 100%; }
      .estimate-totals { grid-template-columns: 1fr; }
      .progress-label { font-size: 11px; }
      .progress-circle { width: 36px; height: 36px; font-size: 14px; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: var(--border-gold); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--gold); }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="ea-header">
    <div class="ea-logo">EA COLLECTIBLES</div>
    <span class="ea-badge">Trade-In Portal</span>
  </header>

  <div class="container">
    <div class="main-card">
      <div class="card-header">
        <h1 class="card-title">TRADE-IN PORTAL</h1>
        <p class="card-subtitle">Turn your cards into cash or store credit in minutes</p>
      </div>

      <div class="card-content">
        <!-- Progress Indicator -->
        <div class="progress-indicator">
          <div class="progress-step active" data-step="1">
            <div class="progress-circle">1</div>
            <div class="progress-label">Contact</div>
          </div>
          <div class="progress-step" data-step="2">
            <div class="progress-circle">2</div>
            <div class="progress-label">Cards</div>
          </div>
          <div class="progress-step" data-step="3">
            <div class="progress-circle">3</div>
            <div class="progress-label">Payout</div>
          </div>
          <div class="progress-step" data-step="4">
            <div class="progress-circle">4</div>
            <div class="progress-label">Review</div>
          </div>
        </div>

        <form id="customer-trade-form">
          <!-- Step 1: Contact -->
          <div class="step-section active" data-step="1">
            <h3 class="step-title"><span>üìß</span><span>Your Contact Information</span></h3>
            <div class="info-box">
              <div class="icon">‚ÑπÔ∏è</div>
              <div class="text">We'll use your email to send you updates about your trade-in request and issue store credit if selected.</div>
            </div>
            <div class="form-group">
              <label class="form-label" for="customerName">Full Name</label>
              <input type="text" class="form-input" id="customerName" placeholder="Enter your full name" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="customerEmail">Email Address</label>
              <input type="email" class="form-input" id="customerEmail" placeholder="your@email.com" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="customerPhone">Phone Number (Optional)</label>
              <input type="tel" class="form-input" id="customerPhone" placeholder="(555) 123-4567">
            </div>
          </div>

          <!-- Step 2: Add Cards -->
          <div class="step-section" data-step="2">
            <h3 class="step-title"><span>üÉè</span><span>Cards to Trade</span></h3>
            <div class="info-box">
              <div class="icon">üí°</div>
              <div class="text">Search for your cards below or scan them with your camera. Our system will find matches and provide instant estimates.</div>
            </div>
            <div class="cards-section">
              <div class="cards-header">
                <h4>Your Cards</h4>
                <div class="cards-header-actions">
                  <button type="button" class="btn btn-secondary" id="scan-card">
                    <span>üì∑</span><span>Scan</span>
                  </button>
                  <button type="button" class="btn btn-secondary" id="add-card">
                    <span>‚ûï</span><span>Add Card</span>
                  </button>
                </div>
              </div>
              <div class="cards-list" id="card-list">
                <div class="card-row">
                  <div class="card-input-container">
                    <input type="text" class="card-input" name="cardName" placeholder="Enter card name or SKU" required>
                  </div>
                  <input type="number" class="form-input" name="cardQuantity" placeholder="Qty" min="1" value="1" required style="width: 90px;">
                  <button type="button" class="remove-btn">‚úï</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 3: Payout -->
          <div class="step-section" data-step="3">
            <h3 class="step-title"><span>üí∞</span><span>Choose Your Payout</span></h3>
            <div class="info-box warning">
              <div class="icon">‚≠ê</div>
              <div class="text"><strong>Pro Tip:</strong> Store credit typically offers 10-15% higher value than cash payouts!</div>
            </div>
            <div class="form-group">
              <label class="form-label">Payout Method</label>
              <div class="payout-options">
                <div class="payout-option">
                  <input type="radio" class="payout-radio" name="payoutMethod" value="store-credit" id="store-credit">
                  <label class="payout-label" for="store-credit">
                    <span class="icon">üè™</span>
                    <span class="label">Store Credit</span>
                    <span class="rate">Best Value</span>
                  </label>
                </div>
                <div class="payout-option">
                  <input type="radio" class="payout-radio" name="payoutMethod" value="gift-card" id="gift-card">
                  <label class="payout-label" for="gift-card">
                    <span class="icon">üéÅ</span>
                    <span class="label">Gift Card</span>
                    <span class="rate">Instant</span>
                  </label>
                </div>
                <div class="payout-option">
                  <input type="radio" class="payout-radio" name="payoutMethod" value="cash" id="cash">
                  <label class="payout-label" for="cash">
                    <span class="icon">üíµ</span>
                    <span class="label">Cash</span>
                    <span class="rate">In-Store</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 4: Review -->
          <div class="step-section" data-step="4">
            <h3 class="step-title"><span>‚úÖ</span><span>Review & Submit</span></h3>
            <div class="info-box">
              <div class="icon">üîç</div>
              <div class="text">Review your information below, then get an instant estimate before submitting.</div>
            </div>
            <div id="review-summary" style="background: rgba(255,255,255,0.02); border-radius: 14px; padding: 24px; margin: 24px 0; border: 1px solid var(--border);">
              <h4 style="margin: 0 0 16px 0; font-size: 16px; color: var(--gold);">üìã Trade-In Summary</h4>
              <div id="summary-content"></div>
            </div>
            <div style="text-align: center; margin: 32px 0;">
              <button type="button" class="btn btn-primary" id="get-estimate">
                <span>üìä</span><span>Get Instant Estimate</span>
              </button>
            </div>
            <div id="estimate-results" class="estimate-results">
              <div style="margin-bottom: 20px;">
                <h4 style="margin: 0 0 16px 0; font-size: 18px; color: var(--green);">üìä Your Estimate</h4>
                <div id="estimate-cards"></div>
              </div>
              <div class="estimate-totals">
                <div>
                  <div class="total-label">Retail Value</div>
                  <div class="total-value" id="total-retail">$0.00</div>
                </div>
                <div>
                  <div class="total-label">Your Payout</div>
                  <div class="total-value primary" id="total-payout">$0.00</div>
                </div>
              </div>
            </div>
            <div style="text-align: center; margin: 32px 0;">
              <button type="submit" class="btn btn-success" id="submit-request" style="display: none;">
                <span>üöÄ</span><span>Submit Trade-In</span>
              </button>
            </div>
          </div>

          <!-- Navigation -->
          <div class="step-navigation">
            <button type="button" class="btn btn-secondary" id="prev-step" style="display: none;">
              <span>‚Üê</span><span>Back</span>
            </button>
            <button type="button" class="btn btn-primary" id="next-step">
              <span>Continue</span><span>‚Üí</span>
            </button>
          </div>
        </form>

        <!-- Success Section -->
        <div id="success-section" class="success-section">
          <div class="success-icon">üéâ</div>
          <h2 class="success-title">SUBMISSION RECEIVED!</h2>
          <p class="success-message">Thank you! We've received your trade-in request and will review it within 24 hours. Check your email for updates.</p>
          <div class="submission-id">
            <strong>Confirmation:</strong> <span id="submission-id-display">TR-2025-XXXX</span>
          </div>
          <div style="margin-top: 32px;">
            <button type="button" class="btn btn-primary" id="new-request">
              <span>üîÑ</span><span>Submit Another</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api/buybackstep4';
    const SUBMISSION_API_URL = '/api/customer-submissions';
    let currentStep = 1;
    const totalSteps = 4;
    let lastApiResponse = null;

    document.addEventListener('DOMContentLoaded', function() {
      setupNavigation();
      setupCardManagement();
      setupFormSubmission();
    });

    function setupNavigation() {
      document.getElementById('next-step').addEventListener('click', function() {
        if (validateCurrentStep()) {
          if (currentStep < totalSteps) goToStep(currentStep + 1);
        }
      });

      document.getElementById('prev-step').addEventListener('click', function() {
        if (currentStep > 1) goToStep(currentStep - 1);
      });
    }

    function goToStep(step) {
      document.querySelector(`.step-section[data-step="${currentStep}"]`).classList.remove('active');
      document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('active');
      document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('completed');

      currentStep = step;
      document.querySelector(`.step-section[data-step="${currentStep}"]`).classList.add('active');
      document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('active');

      updateNavigationButtons();

      if (currentStep === 4) {
        updateReviewSummary();
      }
    }

    function updateNavigationButtons() {
      const nextBtn = document.getElementById('next-step');
      const prevBtn = document.getElementById('prev-step');

      prevBtn.style.display = currentStep > 1 ? 'inline-flex' : 'none';
      
      if (currentStep === totalSteps) {
        nextBtn.style.display = 'none';
      } else {
        nextBtn.style.display = 'inline-flex';
      }
    }

    function validateCurrentStep() {
      switch (currentStep) {
        case 1:
          const name = document.getElementById('customerName').value.trim();
          const email = document.getElementById('customerEmail').value.trim();
          if (!name) {
            alert('Please enter your full name.');
            return false;
          }
          if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            alert('Please enter a valid email address.');
            return false;
          }
          return true;
        case 2:
          const cardRows = document.querySelectorAll('.card-row');
          if (cardRows.length === 0) {
            alert('Please add at least one card to trade.');
            return false;
          }
          let hasValidCard = false;
          cardRows.forEach(row => {
            const cardName = row.querySelector('[name="cardName"]').value.trim();
            if (cardName) hasValidCard = true;
          });
          if (!hasValidCard) {
            alert('Please enter at least one card name.');
            return false;
          }
          return true;
        case 3:
          const payoutSelected = document.querySelector('input[name="payoutMethod"]:checked');
          if (!payoutSelected) {
            alert('Please select a payout method.');
            return false;
          }
          return true;
        default:
          return true;
      }
    }

    function setupCardManagement() {
      // Initial card search setup
      const initialInput = document.querySelector('.card-input');
      if (initialInput) {
        setupCardSearch(initialInput);
      }

      // Add card button
      document.getElementById('add-card').addEventListener('click', function() {
        addNewCardRow();
      });

      // Scan card button
      document.getElementById('scan-card').addEventListener('click', function() {
        handleScanCard();
      });

      // Remove button for first card
      document.querySelector('.remove-btn').addEventListener('click', function() {
        const cardList = document.getElementById('card-list');
        if (cardList.children.length > 1) {
          this.closest('.card-row').remove();
        } else {
          alert('You must have at least one card.');
        }
      });
    }

    function addNewCardRow() {
      const cardList = document.getElementById('card-list');
      const newRow = document.createElement('div');
      newRow.className = 'card-row';
      newRow.innerHTML = `
        <div class="card-input-container">
          <input type="text" class="card-input" name="cardName" placeholder="Enter card name or SKU" required>
        </div>
        <input type="number" class="form-input" name="cardQuantity" placeholder="Qty" min="1" value="1" required style="width: 90px;">
        <button type="button" class="remove-btn">‚úï</button>
      `;
      cardList.appendChild(newRow);

      newRow.querySelector('.remove-btn').addEventListener('click', function() {
        if (cardList.children.length > 1) {
          newRow.remove();
        }
      });

      setupCardSearch(newRow.querySelector('.card-input'));
      
      return newRow;
    }

    function setupCardSearch(input) {
      let searchTimeout;
      let currentSuggestion = null;

      input.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (currentSuggestion) {
          currentSuggestion.remove();
          currentSuggestion = null;
        }

        if (searchTimeout) clearTimeout(searchTimeout);

        if (query.length < 2) {
          input.classList.remove('confirmed', 'not-found');
          return;
        }

        searchTimeout = setTimeout(() => performCardSearch(query, input), 500);
      });

      async function performCardSearch(query, input) {
        const container = input.closest('.card-input-container');
        
        try {
          const response = await fetch(`${API_URL}?estimate=true`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              cards: [{ cardName: query, quantity: 1, condition: 'NM' }],
              employeeName: 'Customer Portal',
              payoutMethod: 'cash'
            })
          });

          const data = await response.json();
          const result = data.results && data.results[0];
          
          if (result && result.allOptions && result.allOptions.length > 1) {
            showMultipleOptions(container, input, query, result);
          } else {
            showSingleResult(container, input, query, result);
          }
        } catch (error) {
          console.error('Search error:', error);
        }
      }

      function showMultipleOptions(container, input, query, result) {
        const existing = container.querySelector('.search-suggestion');
        if (existing) existing.remove();

        const suggestion = document.createElement('div');
        suggestion.className = 'search-suggestion';
        
        const options = result.allOptions || [];
        
        let html = `
          <div style="padding: 16px 18px; border-bottom: 1px solid var(--border); background: rgba(212,175,55,0.1); text-align: center;">
            <div style="font-weight: 600; color: var(--gold); margin-bottom: 4px;">
              üîç Found ${options.length} matches
            </div>
            <div style="font-size: 13px; color: var(--text-muted);">Select the correct card:</div>
          </div>
          <div style="max-height: 280px; overflow-y: auto;">
        `;
        
        options.forEach((option, index) => {
          const isRecommended = index === 0;
          const title = option.fullTitle || option.productTitle || 'Unknown';
          const price = option.price || 0;
          
          html += `
            <div class="option-item">
              <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">
                  ${isRecommended ? '‚≠ê ' : ''}${title}
                </div>
                <div style="font-size: 13px; color: var(--text-muted);">
                  SKU: ${option.sku} ‚Ä¢ $${price.toFixed(2)}
                </div>
              </div>
              <button type="button" class="option-select-btn" data-option-index="${index}" style="
                padding: 10px 18px;
                background: ${isRecommended ? 'linear-gradient(135deg, var(--green-dark), var(--green))' : 'linear-gradient(135deg, var(--gold), var(--gold-dark))'};
                color: #0a0a0a;
                border: none;
                border-radius: 8px;
                font-weight: 700;
                font-size: 13px;
                cursor: pointer;
              ">${isRecommended ? '‚≠ê Select' : 'Select'}</button>
            </div>
          `;
        });
        
        html += `
          </div>
          <div style="padding: 14px 18px; border-top: 1px solid var(--border); text-align: center;">
            <button type="button" class="reject-btn" style="
              padding: 10px 24px;
              background: rgba(255,255,255,0.05);
              color: var(--text-muted);
              border: 1px solid var(--border);
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
            ">‚úï Cancel</button>
          </div>
        `;

        suggestion.innerHTML = html;
        container.appendChild(suggestion);
        currentSuggestion = suggestion;

        suggestion.querySelectorAll('.option-select-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const optionIndex = parseInt(this.getAttribute('data-option-index'));
            const selectedOption = options[optionIndex];
            
            input.classList.add('confirmed');
            input.value = selectedOption.fullTitle || selectedOption.productTitle;
            input.setAttribute('data-search-result', JSON.stringify({
              match: selectedOption.fullTitle || selectedOption.productTitle,
              sku: selectedOption.sku,
              retailPrice: selectedOption.price,
              searchMethod: 'confirmed_search'
            }));
            
            this.innerHTML = '‚úì Selected';
            this.style.background = 'var(--green)';
            
            setTimeout(() => {
              suggestion.remove();
              currentSuggestion = null;
            }, 300);
          });
        });

        suggestion.querySelector('.reject-btn').addEventListener('click', function() {
          input.value = '';
          suggestion.remove();
          currentSuggestion = null;
        });
      }

      function showSingleResult(container, input, query, result) {
        const existing = container.querySelector('.search-suggestion');
        if (existing) existing.remove();

        const suggestion = document.createElement('div');
        suggestion.className = 'search-suggestion';
        
        if (result && result.match) {
          suggestion.innerHTML = `
            <div style="padding: 18px; display: flex; justify-content: space-between; align-items: center; gap: 16px;">
              <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px; color: var(--green);">‚úì ${result.match}</div>
                <div style="font-size: 13px; color: var(--text-muted);">
                  SKU: ${result.sku || 'N/A'} ‚Ä¢ ${result.retailPrice ? '$' + result.retailPrice.toFixed(2) : '$0.00'}
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button type="button" class="confirm-btn" style="padding: 10px 18px; background: linear-gradient(135deg, var(--green-dark), var(--green)); color: #0a0a0a; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">‚úì Use This</button>
                <button type="button" class="reject-btn" style="padding: 10px 18px; background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--border); border-radius: 8px; font-weight: 600; cursor: pointer;">‚úï</button>
              </div>
            </div>
          `;
        } else {
          suggestion.innerHTML = `
            <div style="padding: 18px; display: flex; justify-content: space-between; align-items: center; gap: 16px;">
              <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px; color: var(--warning);">‚ö† "${query}" not found</div>
                <div style="font-size: 13px; color: var(--text-muted);">This item will be manually reviewed</div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button type="button" class="continue-btn" style="padding: 10px 18px; background: linear-gradient(135deg, #f59e0b, #d97706); color: #0a0a0a; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">Continue</button>
                <button type="button" class="reject-btn" style="padding: 10px 18px; background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--border); border-radius: 8px; font-weight: 600; cursor: pointer;">‚úï</button>
              </div>
            </div>
          `;
        }

        container.appendChild(suggestion);
        currentSuggestion = suggestion;

        const confirmBtn = suggestion.querySelector('.confirm-btn');
        const continueBtn = suggestion.querySelector('.continue-btn');
        const rejectBtn = suggestion.querySelector('.reject-btn');

        if (confirmBtn) {
          confirmBtn.addEventListener('click', function() {
            input.classList.add('confirmed');
            input.value = result.match;
            input.setAttribute('data-search-result', JSON.stringify({
              match: result.match,
              sku: result.sku,
              retailPrice: result.retailPrice,
              searchMethod: 'confirmed_search'
            }));
            suggestion.remove();
            currentSuggestion = null;
          });
        }

        if (continueBtn) {
          continueBtn.addEventListener('click', function() {
            input.classList.add('not-found');
            suggestion.remove();
            currentSuggestion = null;
          });
        }

        if (rejectBtn) {
          rejectBtn.addEventListener('click', function() {
            suggestion.remove();
            currentSuggestion = null;
          });
        }
      }
    }

    // OCR Scan Card Function
    function handleScanCard() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.capture = 'environment';
      
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const scanBtn = document.getElementById('scan-card');
        const originalHTML = scanBtn.innerHTML;
        
        scanBtn.innerHTML = '<span class="spinner"></span><span>Reading...</span>';
        scanBtn.disabled = true;
        
        try {
          const { data: { text, confidence } } = await Tesseract.recognize(
            file,
            'eng',
            {
              logger: (m) => {
                if (m.status === 'recognizing text') {
                  const percent = Math.round(m.progress * 100);
                  scanBtn.innerHTML = `<span class="spinner"></span><span>${percent}%</span>`;
                }
              }
            }
          );
          
          let cardNumber = null;
          const patterns = [
            /NO\.\s*(\d{4})/i,
            /(\d{3,4})[\/\-](\d{3})/,
            /#(\d{3,4})/,
            /\b(\d{3,4})\s*\/\s*(\d{3})\b/
          ];
          
          for (const pattern of patterns) {
            const match = text.match(pattern);
            if (match) {
              if (match[2]) {
                cardNumber = match[1] + match[2];
              } else {
                cardNumber = match[1];
              }
              break;
            }
          }
          
          let pokemonName = null;
          const nameMatch = text.match(/(?:^|\n)([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)\s*(?:HP|[0-9])/m);
          if (nameMatch) {
            pokemonName = nameMatch[1].trim();
          }
          
          const alertMsg = `üì± OCR Result:\n\nPok√©mon: ${pokemonName || 'Unknown'}\nCard #: ${cardNumber || 'Not detected'}\nConfidence: ${Math.round(confidence)}%\n\nClick OK to search, or Cancel to try again.`;
          
          if (!confirm(alertMsg)) {
            scanBtn.innerHTML = originalHTML;
            scanBtn.disabled = false;
            return;
          }
          
          scanBtn.innerHTML = '<span class="spinner"></span><span>Matching...</span>';
          
          const formData = new FormData();
          formData.append('image', file);
          formData.append('search_type', 'pokemon_card');
          formData.append('extracted_text', text);
          formData.append('match_threshold', '0.3');
          
          if (cardNumber) {
            formData.append('card_number', cardNumber);
          }
          
          const response = await fetch('/api/shopify-image-match', {
            method: 'POST',
            body: formData
          });
          
          if (!response.ok) {
            throw new Error(`API returned ${response.status}`);
          }
          
          const data = await response.json();
          
          if (data.matches && data.matches.length > 0) {
            const match = data.matches[0];
            const cardList = document.getElementById('card-list');
            const newRow = document.createElement('div');
            newRow.className = 'card-row';
            newRow.innerHTML = `
              <div class="card-input-container">
                <input type="text" class="card-input confirmed" name="cardName" placeholder="Enter card name or SKU" value="${match.title}" required>
              </div>
              <input type="number" class="form-input" name="cardQuantity" placeholder="Qty" min="1" value="1" required style="width: 90px;">
              <button type="button" class="remove-btn">‚úï</button>
            `;
            
            cardList.appendChild(newRow);
            
            newRow.querySelector('.remove-btn').addEventListener('click', function() {
              if (cardList.children.length > 1) {
                newRow.remove();
              }
            });
            
            const inputEl = newRow.querySelector('[name="cardName"]');
            if (inputEl) {
              inputEl.setAttribute('data-search-result', JSON.stringify({
                match: match.title,
                sku: match.sku,
                retailPrice: parseFloat(match.price),
                searchMethod: 'image_scan'
              }));
              setupCardSearch(inputEl);
            }
            
            scanBtn.innerHTML = '‚úì Added!';
            setTimeout(() => {
              scanBtn.innerHTML = originalHTML;
              scanBtn.disabled = false;
            }, 2000);
            
          } else {
            alert(`No matches found.\n\nOCR extracted:\nPok√©mon: ${pokemonName || 'Unknown'}\nCard #: ${cardNumber || 'Not detected'}\n\nTry entering the card name manually.`);
            scanBtn.innerHTML = originalHTML;
            scanBtn.disabled = false;
          }
          
        } catch (error) {
          console.error('Scan error:', error);
          alert(`Scan failed: ${error.message}`);
          scanBtn.innerHTML = originalHTML;
          scanBtn.disabled = false;
        }
      };
      
      input.click();
    }

    function updateReviewSummary() {
      const name = document.getElementById('customerName').value;
      const email = document.getElementById('customerEmail').value;
      const phone = document.getElementById('customerPhone').value;
      const payoutMethod = document.querySelector('input[name="payoutMethod"]:checked')?.value;

      const cards = Array.from(document.querySelectorAll('.card-row')).map(row => ({
        name: row.querySelector('[name="cardName"]').value,
        quantity: row.querySelector('[name="cardQuantity"]').value
      }));

      const payoutNames = {
        'store-credit': 'üè™ Store Credit',
        'gift-card': 'üéÅ Gift Card',
        'cash': 'üíµ Cash'
      };

      let html = `
        <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
          <div style="color: var(--text-muted); font-size: 13px; margin-bottom: 4px;">Contact</div>
          <div style="color: var(--text-primary);">${name} (${email})</div>
          ${phone ? `<div style="color: var(--text-secondary); font-size: 14px;">${phone}</div>` : ''}
        </div>
        <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
          <div style="color: var(--text-muted); font-size: 13px; margin-bottom: 4px;">Payout Method</div>
          <div style="color: var(--gold); font-weight: 600;">${payoutNames[payoutMethod] || 'Not selected'}</div>
        </div>
        <div>
          <div style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">Cards (${cards.length} total)</div>
      `;

      cards.forEach(card => {
        html += `
          <div style="background: rgba(255,255,255,0.03); padding: 12px 14px; margin: 8px 0; border-radius: 8px; border: 1px solid var(--border); display: flex; justify-content: space-between;">
            <span style="color: var(--text-primary);">${card.name || 'Unnamed card'}</span>
            <span style="color: var(--text-muted);">√ó${card.quantity}</span>
          </div>
        `;
      });

      html += '</div>';
      document.getElementById('summary-content').innerHTML = html;
    }

    function setupFormSubmission() {
      document.getElementById('get-estimate').addEventListener('click', async function() {
        const cards = Array.from(document.querySelectorAll('.card-row')).map(row => {
          const input = row.querySelector('[name="cardName"]');
          const searchResult = input.getAttribute('data-search-result');
          
          if (searchResult) {
            try {
              const result = JSON.parse(searchResult);
              return {
                cardName: input.value,
                quantity: parseInt(row.querySelector('[name="cardQuantity"]').value) || 1,
                condition: 'NM',
                sku: result.sku,
                searchMethod: 'exact_sku'
              };
            } catch (e) {}
          }
          
          return {
            cardName: input.value,
            quantity: parseInt(row.querySelector('[name="cardQuantity"]').value) || 1,
            condition: 'NM'
          };
        });

        const btn = this;
        btn.innerHTML = '<span class="spinner"></span><span>Calculating...</span>';
        btn.disabled = true;

        try {
          const response = await fetch(`${API_URL}?estimate=true`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              cards: cards,
              employeeName: 'Customer Portal',
              payoutMethod: document.querySelector('input[name="payoutMethod"]:checked').value
            })
          });

          const data = await response.json();
          lastApiResponse = data;

          if (!response.ok) throw new Error(data.error || 'Failed to get estimate');

          const estimateCards = document.getElementById('estimate-cards');
          estimateCards.innerHTML = '';

          data.results.forEach(card => {
            const cardEl = document.createElement('div');
            cardEl.className = 'estimate-card';
            cardEl.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div style="font-weight: 600; color: var(--text-primary);">
                  ${card.match || card.cardName} ${!card.match ? '<span style="color: var(--warning);">‚ö†</span>' : '<span style="color: var(--green);">‚úì</span>'}
                </div>
                <div style="font-size: 13px; color: var(--text-muted);">√ó${card.quantity}</div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; text-align: center;">
                <div>
                  <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Retail</div>
                  <div style="font-weight: 600; color: var(--text-secondary);">$${card.retailPrice ? card.retailPrice.toFixed(2) : '0.00'}</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Payout</div>
                  <div style="font-weight: 600; color: var(--gold);">$${card.suggestedTradeValue ? card.suggestedTradeValue.toFixed(2) : 'TBD'}</div>
                </div>
              </div>
            `;
            estimateCards.appendChild(cardEl);
          });

          document.getElementById('total-retail').textContent = `$${data.totalRetailValue || '0.00'}`;
          document.getElementById('total-payout').textContent = `$${data.suggestedTotal || '0.00'}`;

          document.getElementById('estimate-results').classList.add('visible');
          document.getElementById('submit-request').style.display = 'inline-flex';

        } catch (error) {
          alert('Error: ' + error.message);
        } finally {
          btn.innerHTML = '<span>üìä</span><span>Get Instant Estimate</span>';
          btn.disabled = false;
        }
      });

      document.getElementById('customer-trade-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const payoutMethodElement = document.querySelector('input[name="payoutMethod"]:checked');
        if (!payoutMethodElement) {
          alert('Please select a payout method.');
          goToStep(3);
          return;
        }
        
        const cards = Array.from(document.querySelectorAll('.card-row')).map(row => {
          const input = row.querySelector('[name="cardName"]');
          const searchResult = input.getAttribute('data-search-result');
          
          let cardData = {
            cardName: input.value,
            quantity: parseInt(row.querySelector('[name="cardQuantity"]').value) || 1,
            condition: 'NM'
          };

          if (searchResult) {
            try {
              const result = JSON.parse(searchResult);
              cardData.sku = result.sku;
              cardData.searchMethod = 'exact_sku';
            } catch (e) {}
          }

          return cardData;
        });

        const submitBtn = document.getElementById('submit-request');
        submitBtn.innerHTML = '<span class="spinner"></span><span>Submitting...</span>';
        submitBtn.disabled = true;

        try {
          const response = await fetch(SUBMISSION_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              customerName: document.getElementById('customerName').value,
              customerEmail: document.getElementById('customerEmail').value,
              customerPhone: document.getElementById('customerPhone').value,
              payoutMethod: payoutMethodElement.value,
              cards: cards,
              submissionType: 'customer_request',
              estimateData: lastApiResponse
            })
          });

          const data = await response.json();

          if (!response.ok) throw new Error(data.error || 'Failed to submit');

          document.getElementById('submission-id-display').textContent = data.submissionId;
          document.getElementById('customer-trade-form').style.display = 'none';
          document.getElementById('success-section').classList.add('visible');

        } catch (error) {
          alert('Error: ' + error.message);
          submitBtn.innerHTML = '<span>üöÄ</span><span>Submit Trade-In</span>';
          submitBtn.disabled = false;
        }
      });

      document.getElementById('new-request').addEventListener('click', function() {
        location.reload();
      });
    }
  </script>
</body>
</html>


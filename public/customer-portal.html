<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trade-In Your Cards</title>
  
  <style>
    :root {
      --primary: #3b82f6;
      --primary-light: #60a5fa;
      --primary-dark: #1d4ed8;
      --accent: #10b981;
      --accent-light: #34d399;
      --success: #059669;
      --warning: #f59e0b;
      --error: #ef4444;
      
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      
      --font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      --border-radius: 12px;
      --border-radius-lg: 16px;
      --border-radius-xl: 20px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 50%, var(--primary) 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      color: var(--gray-800);
      line-height: 1.6;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .main-card {
      background: white;
      border-radius: var(--border-radius-xl);
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--gray-200);
      overflow: hidden;
      animation: slideUp 0.6s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-header {
      background: linear-gradient(135deg, var(--gray-800) 0%, var(--gray-900) 100%);
      color: white;
      padding: 32px;
      text-align: center;
    }

    .card-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.025em;
    }

    .card-subtitle {
      font-size: 16px;
      opacity: 0.9;
      margin: 8px 0 0 0;
      font-weight: 400;
    }

    .card-content {
      padding: 40px;
    }

    .progress-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
    }

    .progress-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 60%;
      right: -40%;
      height: 2px;
      background: var(--gray-200);
      z-index: 1;
    }

    .progress-step.active:not(:last-child)::after {
      background: var(--primary);
    }

    .progress-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gray-200);
      color: var(--gray-500);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-bottom: 8px;
      position: relative;
      z-index: 2;
      transition: all 0.3s ease;
    }

    .progress-step.active .progress-circle {
      background: var(--primary);
      color: white;
    }

    .progress-step.completed .progress-circle {
      background: var(--success);
      color: white;
    }

    .progress-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-600);
      text-align: center;
    }

    .progress-step.active .progress-label {
      color: var(--primary);
    }

    .step-section {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .step-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .step-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--gray-800);
      margin: 0 0 20px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius);
      font-size: 16px;
      background: white;
      transition: all 0.2s ease;
      font-family: var(--font-family);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-input::placeholder {
      color: var(--gray-400);
    }

    .payout-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }

    .payout-option {
      position: relative;
      cursor: pointer;
    }

    .payout-radio {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .payout-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 20px;
      background: white;
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius);
      font-weight: 500;
      font-size: 16px;
      transition: all 0.2s ease;
      cursor: pointer;
      text-align: center;
    }

    .payout-option:hover .payout-label {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .payout-radio:checked + .payout-label {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-md);
    }

    .cards-section {
      background: var(--gray-50);
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-200);
      overflow: visible;
    }

    .cards-header {
      background: white;
      padding: 24px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cards-list {
      padding: 24px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .cards-list::-webkit-scrollbar {
      width: 8px;
    }

    .cards-list::-webkit-scrollbar-track {
      background: var(--gray-100);
      border-radius: 4px;
    }

    .cards-list::-webkit-scrollbar-thumb {
      background: var(--gray-400);
      border-radius: 4px;
    }

    .card-row {
      display: grid;
      grid-template-columns: 2fr auto auto auto;
      gap: 16px;
      align-items: start;
      padding: 20px;
      background: white;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-200);
      margin-bottom: 16px;
      transition: all 0.2s ease;
      position: relative;
    }

    .card-row:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .card-input-container {
      position: relative;
    }

    .card-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius);
      font-size: 16px;
      transition: all 0.2s ease;
    }

    .card-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .card-input.confirmed {
      border-color: var(--success);
      background: rgba(5, 150, 105, 0.05);
    }

    .card-input.not-found {
      border-color: var(--warning);
      background: rgba(245, 158, 11, 0.05);
    }

    .search-suggestion {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--primary);
      border-top: none;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      animation: slideDown 0.2s ease;
      max-height: 400px;
      overflow-y: auto;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .suggestion-content {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .suggestion-info {
      flex: 1;
      min-width: 0;
    }

    .suggestion-name {
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 4px;
      word-wrap: break-word;
    }

    .suggestion-details {
      font-size: 14px;
      color: var(--gray-500);
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: var(--primary);
      color: white;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .search-badge.found {
      background: var(--success);
    }

    .search-badge.not-found {
      background: var(--warning);
    }

    .suggestion-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .suggestion-btn {
      padding: 8px 16px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .confirm-btn {
      background: var(--success);
      color: white;
    }

    .confirm-btn:hover {
      background: #047857;
      transform: translateY(-1px);
    }

    .reject-btn {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .reject-btn:hover {
      background: var(--gray-300);
    }

    .continue-btn {
      background: var(--warning);
      color: white;
    }

    .continue-btn:hover {
      background: #d97706;
    }

    .option-item {
      padding: 12px;
      margin: 4px 0;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .option-item:hover {
      background: var(--gray-100);
      border-color: var(--primary);
    }

    .option-item.selected {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--primary);
    }

    .remove-btn {
      background: var(--error);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      padding: 8px 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 16px;
    }

    .remove-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 28px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #047857;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .step-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
      padding-top: 24px;
      border-top: 1px solid var(--gray-200);
    }

    .estimate-results {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: var(--border-radius);
      padding: 32px;
      margin: 32px 0;
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .estimate-results.visible {
      opacity: 1;
      max-height: none;
      overflow: visible;
    }

    .estimate-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .estimate-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--gray-800);
    }

    #estimate-cards {
      max-height: 50vh;
      overflow-y: auto;
      margin-bottom: 24px;
      padding-right: 8px;
    }

    #estimate-cards::-webkit-scrollbar {
      width: 6px;
    }

    #estimate-cards::-webkit-scrollbar-track {
      background: var(--gray-100);
      border-radius: 3px;
    }

    #estimate-cards::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }

    .estimate-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid var(--gray-200);
      box-shadow: var(--shadow-sm);
    }

    .estimate-totals {
      background: white;
      border-radius: var(--border-radius);
      padding: 24px;
      border: 2px solid var(--primary);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      text-align: center;
    }

    .total-item {
      padding: 16px;
      border-radius: var(--border-radius);
      background: var(--gray-50);
    }

    .total-label {
      font-size: 14px;
      color: var(--gray-600);
      margin-bottom: 4px;
    }

    .total-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--gray-800);
    }

    .total-value.primary {
      color: var(--primary);
    }

    .success-section {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%);
      border: 2px solid var(--success);
      border-radius: var(--border-radius);
      padding: 40px;
      text-align: center;
      display: none;
    }

    .success-section.visible {
      display: block;
      animation: successSlideIn 0.5s ease;
    }

    @keyframes successSlideIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .success-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .success-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 16px;
    }

    .success-message {
      font-size: 18px;
      color: var(--gray-600);
      margin-bottom: 32px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .submission-id {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--border-radius);
      padding: 20px;
      margin: 24px 0;
      font-family: var(--font-mono);
      font-size: 16px;
      color: var(--gray-700);
    }

    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      .card-content {
        padding: 24px;
      }

      .card-row {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .payout-options {
        grid-template-columns: 1fr;
      }

      .step-navigation {
        flex-direction: column;
        gap: 12px;
      }

      .btn {
        justify-content: center;
        width: 100%;
      }

      .estimate-totals {
        grid-template-columns: 1fr;
      }

      .progress-indicator {
        flex-wrap: wrap;
        gap: 12px;
      }

      .progress-step {
        flex: 1;
        min-width: 120px;
      }

      .progress-step:not(:last-child)::after {
        display: none;
      }

      .cards-header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }

      .cards-header > div {
        display: flex;
        gap: 8px;
      }

      .cards-header .btn {
        flex: 1;
        padding: 12px 16px;
        font-size: 14px;
      }
    }

    .info-box {
      background: rgba(59, 130, 246, 0.05);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: var(--border-radius);
      padding: 16px;
      margin: 16px 0;
      display: flex;
      align-items: start;
      gap: 12px;
    }

    .info-box.warning {
      background: rgba(245, 158, 11, 0.05);
      border-color: rgba(245, 158, 11, 0.2);
    }

    .info-box.success {
      background: rgba(16, 185, 129, 0.05);
      border-color: rgba(16, 185, 129, 0.2);
    }

    .info-icon {
      font-size: 20px;
      margin-top: 2px;
    }

    .info-content {
      flex: 1;
      font-size: 14px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-card">
      <div class="card-header">
        <h1 class="card-title">Customer Trade-In Portal</h1>
        <p class="card-subtitle">Complete your trade-in request in just a few easy steps</p>
      </div>

      <div class="card-content">
        <div class="progress-indicator">
          <div class="progress-step active" data-step="1">
            <div class="progress-circle">1</div>
            <div class="progress-label">Contact Info</div>
          </div>
          <div class="progress-step" data-step="2">
            <div class="progress-circle">2</div>
            <div class="progress-label">Add Cards</div>
          </div>
          <div class="progress-step" data-step="3">
            <div class="progress-circle">3</div>
            <div class="progress-label">Choose Payout</div>
          </div>
          <div class="progress-step" data-step="4">
            <div class="progress-circle">4</div>
            <div class="progress-label">Review & Submit</div>
          </div>
        </div>

        <form id="customer-trade-form">
          <div class="step-section active" data-step="1">
            <h3 class="step-title">
              <span>üìß</span>
              <span>Your Contact Information</span>
            </h3>

            <div class="info-box">
              <div class="info-icon">‚ÑπÔ∏è</div>
              <div class="info-content">
                We'll use your email to send you updates about your trade-in request and for store credit if you choose that option.
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="customerName">Full Name</label>
              <input type="text" class="form-input" id="customerName" name="customerName" placeholder="Enter your full name" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="customerEmail">Email Address</label>
              <input type="email" class="form-input" id="customerEmail" name="customerEmail" placeholder="your@email.com" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="customerPhone">Phone Number (Optional)</label>
              <input type="tel" class="form-input" id="customerPhone" name="customerPhone" placeholder="(555) 123-4567">
            </div>
          </div>

          <div class="step-section" data-step="2">
            <h3 class="step-title">
              <span>üÉè</span>
              <span>Cards to Trade</span>
            </h3>

            <div class="info-box">
              <div class="info-icon">üí°</div>
              <div class="info-content">
                <strong>Add your cards manually below.</strong> Our system will search our inventory and provide instant estimates for each card you enter.
              </div>
            </div>

            <div class="cards-section">
              <div class="cards-header">
                <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Your Cards</h4>
                <div style="display: flex; gap: 12px;">
                  <button type="button" class="btn btn-secondary" id="add-card">
                    <span>‚ûï</span>
                    <span>Add Card</span>
                  </button>
                </div>
              </div>
              
              <div class="cards-list" id="card-list">
                <div class="card-row">
                  <div class="card-input-container">
                    <input type="text" class="card-input" name="cardName" placeholder="Enter card name or SKU" required>
                  </div>
                  <input type="number" class="form-input" name="cardQuantity" placeholder="Qty" min="1" value="1" required style="width: 80px;">
                  <select class="form-select" name="cardCondition" required style="width: 120px;">
                    <option value="NM">Near Mint</option>
                    <option value="LP">Lightly Played</option>
                    <option value="MP">Moderately Played</option>
                  </select>
                  <button type="button" class="remove-btn">‚úñ</button>
                </div>
              </div>
            </div>
          </div>

          <div class="step-section" data-step="3">
            <h3 class="step-title">
              <span>üí∞</span>
              <span>How would you like to be paid?</span>
            </h3>

            <div class="info-box warning">
              <div class="info-icon">‚ö†Ô∏è</div>
              <div class="info-content">
                <strong>Important:</strong> Store credit typically offers the best value! Gift cards and cash may have different rates.
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Payout Method</label>
              <div class="payout-options">
                <div class="payout-option">
                  <input type="radio" class="payout-radio" name="payoutMethod" value="store-credit" id="store-credit">
                  <label class="payout-label" for="store-credit">
                    <span>üè™</span>
                    <span>Store Credit<br><small>Best Value!</small></span>
                  </label>
                </div>
                <div class="payout-option">
                  <input type="radio" class="payout-radio" name="payoutMethod" value="gift-card" id="gift-card">
                  <label class="payout-label" for="gift-card">
                    <span>üéÅ</span>
                    <span>Gift Card<br><small>Great for Gifts</small></span>
                  </label>
                </div>
                <div class="payout-option">
                  <input type="radio" class="payout-radio" name="payoutMethod" value="cash" id="cash">
                  <label class="payout-label" for="cash">
                    <span>üíµ</span>
                    <span>Cash<br><small>Instant Payout</small></span>
                  </label>
                </div>
              </div>
            </div>

            <div class="info-box success">
              <div class="info-icon">üìã</div>
              <div class="info-content">
                <strong>Next:</strong> Review your submission and get an instant estimate before finalizing your trade-in request.
              </div>
            </div>
          </div>

          <div class="step-section" data-step="4">
            <h3 class="step-title">
              <span>‚úÖ</span>
              <span>Review Your Trade-In Request</span>
            </h3>

            <div class="info-box">
              <div class="info-icon">üîç</div>
              <div class="info-content">
                Please review all information below. Once submitted, our team will process your request and contact you within 24 hours.
              </div>
            </div>

            <div id="review-summary" style="background: var(--gray-50); border-radius: var(--border-radius); padding: 24px; margin: 24px 0;">
              <h4 style="margin: 0 0 16px 0; color: var(--gray-800);">üìã Trade-In Summary</h4>
              <div id="summary-content">
              </div>
            </div>

            <div style="text-align: center; margin: 32px 0;">
              <button type="button" class="btn btn-primary" id="get-estimate">
                <span>üìä</span>
                <span>Get Instant Estimate</span>
              </button>
            </div>

            <div id="estimate-results" class="estimate-results">
              <div class="estimate-header">
                <div class="estimate-title">üìä Your Trade-In Estimate</div>
              </div>
              
              <div id="estimate-cards">
              </div>

              <div class="estimate-totals">
                <div class="total-item">
                  <div class="total-label">Retail Value</div>
                  <div class="total-value" id="total-retail">$0.00</div>
                </div>
                <div class="total-item">
                  <div class="total-label">Your Payout</div>
                  <div class="total-value primary" id="total-payout">$0.00</div>
                </div>
              </div>

              <div class="info-box success" style="margin-top: 24px;">
                <div class="info-icon">‚ú®</div>
                <div class="info-content">
                  <strong>Great!</strong> This is your estimated payout. Final amounts may vary slightly based on actual card condition when we receive them.
                </div>
              </div>
            </div>

            <div style="text-align: center; margin: 32px 0;">
              <button type="submit" class="btn btn-success" id="submit-request" style="display: none;">
                <span>üöÄ</span>
                <span>Submit Trade-In Request</span>
              </button>
            </div>
          </div>

          <div class="step-navigation">
            <button type="button" class="btn btn-secondary" id="prev-step" style="display: none;">
              <span>‚Üê</span>
              <span>Previous</span>
            </button>
            <button type="button" class="btn btn-primary" id="next-step">
              <span>Next</span>
              <span>‚Üí</span>
            </button>
          </div>
        </form>

        <div id="success-section" class="success-section">
          <div class="success-icon">üéâ</div>
          <h2 class="success-title">Trade-In Request Submitted!</h2>
          <p class="success-message">
            Thank you for your trade-in request! We've received your submission and will review it within 24 hours.
          </p>
          
          <div class="submission-id">
            <strong>Submission ID:</strong> <span id="submission-id-display">TR-2025-XXXX</span>
          </div>

          <div class="info-box success">
            <div class="info-icon">üìß</div>
            <div class="info-content">
              <strong>What's Next?</strong><br>
              ‚Ä¢ You'll receive a confirmation email shortly<br>
              ‚Ä¢ Our team will review your cards and confirm the final payout<br>
              ‚Ä¢ We'll contact you within 24 hours with next steps<br>
              ‚Ä¢ Keep your submission ID for reference
            </div>
          </div>

          <div style="margin-top: 32px;">
            <button type="button" class="btn btn-primary" id="new-request">
              <span>üîÑ</span>
              <span>Submit Another Request</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api/buybackstep4';
    const SUBMISSION_API_URL = '/api/customer-submissions';
    
    let currentStep = 1;
    const totalSteps = 4;
    let lastApiResponse = null;

    document.addEventListener('DOMContentLoaded', function() {
      initializeCustomerPortal();
    });

    function initializeCustomerPortal() {
      setupStepNavigation();
      setupCardManagement();
      setupFormSubmission();
    }

    function setupStepNavigation() {
      const nextBtn = document.getElementById('next-step');
      const prevBtn = document.getElementById('prev-step');

      nextBtn.addEventListener('click', function() {
        if (validateCurrentStep()) {
          if (currentStep < totalSteps) {
            goToStep(currentStep + 1);
          }
        }
      });

      prevBtn.addEventListener('click', function() {
        if (currentStep > 1) {
          goToStep(currentStep - 1);
        }
      });
    }

    function goToStep(step) {
      document.querySelector(`.step-section[data-step="${currentStep}"]`).classList.remove('active');
      document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('active');
      document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('completed');

      currentStep = step;
      document.querySelector(`.step-section[data-step="${currentStep}"]`).classList.add('active');
      document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('active');

      updateNavigationButtons();

      if (currentStep === 4) {
        updateReviewSummary();
      }

      document.querySelector('.main-card').scrollIntoView({ behavior: 'smooth' });
    }

    function updateNavigationButtons() {
      const nextBtn = document.getElementById('next-step');
      const prevBtn = document.getElementById('prev-step');

      prevBtn.style.display = currentStep > 1 ? 'inline-flex' : 'none';
      
      if (currentStep === totalSteps) {
        nextBtn.style.display = 'none';
      } else {
        nextBtn.style.display = 'inline-flex';
        nextBtn.innerHTML = currentStep === totalSteps - 1 ? 
          '<span>Review</span><span>‚Üí</span>' : 
          '<span>Next</span><span>‚Üí</span>';
      }
    }

    function validateCurrentStep() {
      switch (currentStep) {
        case 1:
          return validateContactInfo();
        case 2:
          return validateCards();
        case 3:
          return validatePayoutMethod();
        case 4:
          return true;
        default:
          return true;
      }
    }

    function validateContactInfo() {
      const name = document.getElementById('customerName').value.trim();
      const email = document.getElementById('customerEmail').value.trim();

      if (!name) {
        alert('Please enter your full name.');
        document.getElementById('customerName').focus();
        return false;
      }

      if (!email || !isValidEmail(email)) {
        alert('Please enter a valid email address.');
        document.getElementById('customerEmail').focus();
        return false;
      }

      return true;
    }

    function validateCards() {
      const cardRows = document.querySelectorAll('.card-row');
      
      if (cardRows.length === 0) {
        alert('Please add at least one card to trade.');
        return false;
      }

      for (let row of cardRows) {
        const cardName = row.querySelector('[name="cardName"]').value.trim();
        const quantity = row.querySelector('[name="cardQuantity"]').value;

        if (!cardName) {
          alert('Please fill in all card names.');
          row.querySelector('[name="cardName"]').focus();
          return false;
        }

        if (!quantity || quantity < 1) {
          alert('Please enter a valid quantity for all cards.');
          row.querySelector('[name="cardQuantity"]').focus();
          return false;
        }
      }

      return true;
    }

    function validatePayoutMethod() {
      const selectedMethod = document.querySelector('input[name="payoutMethod"]:checked');
      
      if (!selectedMethod) {
        alert('Please select a payout method.');
        return false;
      }

      return true;
    }

    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function setupCardManagement() {
      const addCardBtn = document.getElementById('add-card');

      addCardBtn.addEventListener('click', function() {
        addNewCardRow();
      });

      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          handleRemoveCard(btn);
        });
      });

      document.querySelectorAll('.card-input').forEach(input => {
        setupCardSearch(input);
      });
    }

    function handleRemoveCard(btn) {
      const cardList = document.getElementById('card-list');
      if (cardList.children.length > 1) {
        btn.closest('.card-row').remove();
      } else {
        alert('You must have at least one card in your trade-in request.');
      }
    }

    function addNewCardRow(cardData = null) {
      const cardList = document.getElementById('card-list');
      const newRow = document.createElement('div');
      newRow.className = 'card-row';
      
      const cardName = cardData ? cardData.name : '';
      const quantity = cardData ? cardData.quantity : 1;
      const condition = cardData ? cardData.condition : 'NM';
      
      newRow.innerHTML = `
        <div class="card-input-container">
          <input type="text" class="card-input" name="cardName" placeholder="Enter card name or SKU" value="${cardName}" required>
        </div>
        <input type="number" class="form-input" name="cardQuantity" placeholder="Qty" min="1" value="${quantity}" required style="width: 80px;">
        <select class="form-select" name="cardCondition" required style="width: 120px;">
          <option value="NM" ${condition === 'NM' ? 'selected' : ''}>Near Mint</option>
          <option value="LP" ${condition === 'LP' ? 'selected' : ''}>Lightly Played</option>
          <option value="MP" ${condition === 'MP' ? 'selected' : ''}>Moderately Played</option>
        </select>
        <button type="button" class="remove-btn">‚úñ</button>
      `;
      cardList.appendChild(newRow);

      newRow.querySelector('.remove-btn').addEventListener('click', function() {
        handleRemoveCard(this);
      });

      setupCardSearch(newRow.querySelector('.card-input'));

      if (cardData && cardData.scanResult) {
        const input = newRow.querySelector('.card-input');
        input.classList.add('confirmed');
        input.setAttribute('data-search-result', JSON.stringify(cardData.scanResult));
      }

      return newRow;
    }

    function setupCardSearch(input) {
      let searchTimeout;
      let currentSuggestion = null;

      input.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (currentSuggestion) {
          currentSuggestion.remove();
          currentSuggestion = null;
        }

        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }

        if (query.length < 2) {
          input.classList.remove('confirmed', 'not-found');
          return;
        }

        searchTimeout = setTimeout(async () => {
          await performCardSearch(query, input);
        }, 500);
      });

      async function performCardSearch(query, input) {
        const container = input.closest('.card-input-container');
        
        try {
          const response = await fetch(`${API_URL}?estimate=true`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              cards: [{ cardName: query, quantity: 1, condition: 'NM' }],
              employeeName: 'Customer Portal',
              payoutMethod: 'cash'
            })
          });

          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || 'Search failed');
          }

          const result = data.results && data.results[0];
          
          if (result && result.allOptions && result.allOptions.length > 1) {
            showMultipleOptions(container, input, query, result);
          } else {
            showSearchResult(container, input, query, result);
          }

        } catch (error) {
          console.error('Search error:', error);
        }
      }

      function showMultipleOptions(container, input, query, result) {
        const existing = container.querySelector('.search-suggestion');
        if (existing) existing.remove();

        const suggestion = document.createElement('div');
        suggestion.className = 'search-suggestion';
        
        let optionsHtml = '<div style="padding: 16px;">';
        optionsHtml += `<div style="margin-bottom: 12px; font-weight: 600;">üîç Multiple matches found for "${query}"</div>`;
        optionsHtml += '<div style="font-size: 14px; color: var(--gray-600); margin-bottom: 12px;">Please select the correct card:</div>';
        
        let selectedOption = null;
        
        result.allOptions.forEach((option, index) => {
          const isRecommended = index === 0;
          optionsHtml += `
            <div class="option-item ${isRecommended ? 'selected' : ''}" data-option-index="${index}">
              <div style="font-weight: 600; margin-bottom: 4px;">
                ${option.fullTitle} ${isRecommended ? '‚≠ê Recommended' : ''}
              </div>
              <div style="font-size: 13px; color: var(--gray-500);">
                SKU: ${option.sku} ‚Ä¢ Price: ${option.price.toFixed(2)}
              </div>
            </div>
          `;
        });
        
        optionsHtml += `
          <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: flex-end;">
            <button type="button" class="suggestion-btn confirm-btn">‚úÖ Use Selected</button>
            <button type="button" class="suggestion-btn reject-btn">‚ùå Cancel</button>
          </div>
        </div>`;
        
        suggestion.innerHTML = optionsHtml;
        container.appendChild(suggestion);
        currentSuggestion = suggestion;

        suggestion.querySelectorAll('.option-item').forEach((item, index) => {
          item.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            suggestion.querySelectorAll('.option-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            selectedOption = result.allOptions[index];
            console.log('Option selected:', selectedOption);
          }, true);
        });

        selectedOption = result.allOptions[0];

        const confirmBtn = suggestion.querySelector('.confirm-btn');
        const rejectBtn = suggestion.querySelector('.reject-btn');

        confirmBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Confirm button clicked for multiple options!', selectedOption);
          if (selectedOption) {
            // Handle both fullTitle and productTitle properties
            const cardTitle = selectedOption.fullTitle || selectedOption.productTitle || selectedOption.title;
            const cardPrice = selectedOption.price || selectedOption.retailPrice || 0;
            
            input.classList.remove('not-found');
            input.classList.add('confirmed');
            input.value = cardTitle;
            input.setAttribute('data-search-result', JSON.stringify({
              match: cardTitle,
              sku: selectedOption.sku,
              retailPrice: cardPrice,
              searchMethod: 'confirmed_search'
            }));
            if (suggestion.parentNode) {
              suggestion.remove();
            }
            currentSuggestion = null;
            console.log('Card selected and confirmed:', cardTitle);
          }
        }, true);

        rejectBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Reject button clicked for multiple options!');
          input.classList.remove('confirmed', 'not-found');
          if (suggestion.parentNode) {
            suggestion.remove();
          }
          currentSuggestion = null;
        }, true);
      }

      function showSearchResult(container, input, query, result) {
        const existing = container.querySelector('.search-suggestion');
        if (existing) existing.remove();

        const suggestion = document.createElement('div');
        suggestion.className = 'search-suggestion';
        
        if (result && result.match) {
          suggestion.innerHTML = `
            <div class="suggestion-content">
              <div class="suggestion-info">
                <div class="suggestion-name">‚úÖ ${result.match}</div>
                <div class="suggestion-details">
                  <span>SKU: ${result.sku || 'N/A'}</span>
                  <span>Est. Value: ${result.retailPrice ? result.retailPrice.toFixed(2) : '0.00'}</span>
                  <span class="search-badge found">Found</span>
                </div>
              </div>
              <div class="suggestion-actions">
                <button type="button" class="suggestion-btn confirm-btn">‚úÖ Use This</button>
                <button type="button" class="suggestion-btn reject-btn">‚ùå Cancel</button>
              </div>
            </div>
          `;
        } else {
          suggestion.innerHTML = `
            <div class="suggestion-content">
              <div class="suggestion-info">
                <div class="suggestion-name">‚ùì "${query}" - Manual Review</div>
                <div class="suggestion-details">
                  <span>This item will be manually reviewed by our team</span>
                  <span class="search-badge not-found">Manual Review</span>
                </div>
              </div>
              <div class="suggestion-actions">
                <button type="button" class="suggestion-btn continue-btn">‚úÖ Continue</button>
                <button type="button" class="suggestion-btn reject-btn">‚ùå Cancel</button>
              </div>
            </div>
          `;
        }

        container.appendChild(suggestion);
        currentSuggestion = suggestion;

        const confirmBtn = suggestion.querySelector('.confirm-btn');
        const continueBtn = suggestion.querySelector('.continue-btn');
        const rejectBtn = suggestion.querySelector('.reject-btn');

        if (confirmBtn) {
          confirmBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Confirm button clicked!', result);
            input.classList.remove('not-found');
            input.classList.add('confirmed');
            input.value = result.match;
            input.setAttribute('data-search-result', JSON.stringify({
              match: result.match,
              sku: result.sku,
              retailPrice: result.retailPrice,
              searchMethod: 'confirmed_search'
            }));
            if (suggestion.parentNode) {
              suggestion.remove();
            }
            currentSuggestion = null;
          }, true);
        }

        if (continueBtn) {
          continueBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Continue button clicked!');
            input.classList.remove('confirmed');
            input.classList.add('not-found');
            if (suggestion.parentNode) {
              suggestion.remove();
            }
            currentSuggestion = null;
          }, true);
        }

        if (rejectBtn) {
          rejectBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Reject button clicked!');
            input.classList.remove('confirmed', 'not-found');
            if (suggestion.parentNode) {
              suggestion.remove();
            }
            currentSuggestion = null;
          }, true);
        }
      }
    }

    function updateReviewSummary() {
      const name = document.getElementById('customerName').value;
      const email = document.getElementById('customerEmail').value;
      const phone = document.getElementById('customerPhone').value;
      const payoutMethod = document.querySelector('input[name="payoutMethod"]:checked')?.value;

      const cards = Array.from(document.querySelectorAll('.card-row')).map(row => {
        return {
          name: row.querySelector('[name="cardName"]').value,
          quantity: row.querySelector('[name="cardQuantity"]').value,
          condition: row.querySelector('[name="cardCondition"]').value
        };
      });

      const payoutMethodNames = {
        'store-credit': 'üè™ Store Credit',
        'gift-card': 'üéÅ Gift Card',
        'cash': 'üíµ Cash'
      };

      let summaryHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
          <div>
            <strong>üìß Contact Information</strong><br>
            <strong>Name:</strong> ${name}<br>
            <strong>Email:</strong> ${email}<br>
            ${phone ? `<strong>Phone:</strong> ${phone}<br>` : ''}
          </div>
          <div>
            <strong>üí∞ Payout Method</strong><br>
            ${payoutMethodNames[payoutMethod] || 'Not selected'}
          </div>
        </div>
        
        <div>
          <strong>üÉè Cards (${cards.length} total)</strong><br>
          <div style="margin-top: 8px;">
      `;

      cards.forEach(card => {
        summaryHTML += `
          <div style="background: white; padding: 12px; margin: 4px 0; border-radius: 8px; border: 1px solid var(--gray-200);">
            <strong>${card.name}</strong> - Qty: ${card.quantity} - Condition: ${card.condition}
          </div>
        `;
      });

      summaryHTML += `
          </div>
        </div>
      `;

      document.getElementById('summary-content').innerHTML = summaryHTML;
    }

    function setupFormSubmission() {
      const form = document.getElementById('customer-trade-form');
      const estimateBtn = document.getElementById('get-estimate');
      const newRequestBtn = document.getElementById('new-request');
      
      estimateBtn.addEventListener('click', async function() {
        await getTradeEstimate();
      });
      
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitTradeRequest();
      });

      newRequestBtn.addEventListener('click', function() {
        location.reload();
      });
    }

    async function getTradeEstimate() {
      const estimateBtn = document.getElementById('get-estimate');
      const estimateResults = document.getElementById('estimate-results');
      
      const cards = Array.from(document.querySelectorAll('.card-row')).map(row => {
        const input = row.querySelector('[name="cardName"]');
        const searchResult = input.getAttribute('data-search-result');
        
        if (searchResult) {
          try {
            const result = JSON.parse(searchResult);
            return {
              cardName: input.value,
              quantity: parseInt(row.querySelector('[name="cardQuantity"]').value) || 1,
              condition: row.querySelector('[name="cardCondition"]').value,
              sku: result.sku,
              searchMethod: 'exact_sku'
            };
          } catch (e) {
            console.warn('Failed to parse search result:', e);
          }
        }
        
        return {
          cardName: input.value,
          quantity: parseInt(row.querySelector('[name="cardQuantity"]').value) || 1,
          condition: row.querySelector('[name="cardCondition"]').value
        };
      });

      estimateBtn.innerHTML = '<span class="spinner"></span><span>Calculating...</span>';
      estimateBtn.disabled = true;

      try {
        const response = await fetch(`${API_URL}?estimate=true`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            cards: cards,
            employeeName: 'Customer Portal',
            payoutMethod: document.querySelector('input[name="payoutMethod"]:checked').value
          })
        });

        const data = await response.json();
        lastApiResponse = data;

        if (!response.ok) {
          throw new Error(data.error || 'Failed to get estimate');
        }

        showEstimateResults(data);
        document.getElementById('submit-request').style.display = 'inline-flex';

      } catch (error) {
        console.error('Estimate error:', error);
        alert('Error getting estimate: ' + error.message);
      } finally {
        estimateBtn.innerHTML = '<span>üìä</span><span>Get Instant Estimate</span>';
        estimateBtn.disabled = false;
      }
    }

    function showEstimateResults(data) {
      const estimateCards = document.getElementById('estimate-cards');
      estimateCards.innerHTML = '';

      data.results.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.className = 'estimate-card';
        cardElement.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div>
              <div style="font-weight: 600; color: var(--gray-800);">
                ${card.match || card.cardName}
                ${!card.match ? ' ‚ùì Manual Review' : ' ‚úÖ'}
              </div>
              <div style="font-size: 14px; color: var(--gray-500);">
                Quantity: ${card.quantity} ‚Ä¢ Condition: ${card.condition}
                ${card.sku ? ` ‚Ä¢ SKU: ${card.sku}` : ''}
              </div>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; text-align: center;">
            <div>
              <div style="font-size: 12px; color: var(--gray-500);">Retail Value</div>
              <div style="font-weight: 600;">${card.retailPrice ? card.retailPrice.toFixed(2) : '0.00'}</div>
            </div>
            <div>
              <div style="font-size: 12px; color: var(--gray-500);">Your Payout</div>
              <div style="font-weight: 600; color: var(--primary);">${card.suggestedTradeValue ? card.suggestedTradeValue.toFixed(2) : 'TBD'}</div>
            </div>
          </div>
        `;
        estimateCards.appendChild(cardElement);
      });

      document.getElementById('total-retail').textContent = `$${data.totalRetailValue || '0.00'}`;
      document.getElementById('total-payout').textContent = `$${data.suggestedTotal || '0.00'}`;

      document.getElementById('estimate-results').classList.add('visible');
    }

    async function submitTradeRequest() {
      const submitBtn = document.getElementById('submit-request');
      
      // Validate payout method is selected
      const payoutMethodElement = document.querySelector('input[name="payoutMethod"]:checked');
      if (!payoutMethodElement) {
        alert('Please select a payout method before submitting.');
        goToStep(3); // Go back to payout method step
        return;
      }
      
      const cards = Array.from(document.querySelectorAll('.card-row')).map(row => {
        const input = row.querySelector('[name="cardName"]');
        const searchResult = input.getAttribute('data-search-result');
        
        let cardData = {
          cardName: input.value,
          quantity: parseInt(row.querySelector('[name="cardQuantity"]').value) || 1,
          condition: row.querySelector('[name="cardCondition"]').value
        };

        if (searchResult) {
          try {
            const result = JSON.parse(searchResult);
            cardData.sku = result.sku;
            cardData.searchMethod = 'exact_sku';
          } catch (e) {
            console.warn('Failed to parse search result:', e);
          }
        }

        return cardData;
      });

      const formData = {
        customerName: document.getElementById('customerName').value,
        customerEmail: document.getElementById('customerEmail').value,
        customerPhone: document.getElementById('customerPhone').value,
        payoutMethod: payoutMethodElement.value,
        cards: cards,
        submissionType: 'customer_request',
        estimateData: lastApiResponse
      };

      submitBtn.innerHTML = '<span class="spinner"></span><span>Submitting...</span>';
      submitBtn.disabled = true;

      try {
        const response = await fetch(SUBMISSION_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to submit request');
        }

        document.getElementById('submission-id-display').textContent = data.submissionId;
        
        document.getElementById('customer-trade-form').style.display = 'none';
        document.getElementById('success-section').classList.add('visible');

      } catch (error) {
        console.error('Submission error:', error);
        alert('Error submitting request: ' + error.message);
        submitBtn.innerHTML = '<span>üöÄ</span><span>Submit Trade-In Request</span>';
        submitBtn.disabled = false;
      }
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TESTING VERSION ‚Äì Buyback Portal</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #f8f9fa;
      line-height: 1.6;
    }

    .testing-banner {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      color: #000;
      text-align: center;
      font-weight: bold;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .main-container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }

    h2 {
      color: #2c3e50;
      font-size: 2em;
      margin-bottom: 25px;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }

    h3 {
      color: #34495e;
      font-size: 1.4em;
      margin-top: 30px;
      margin-bottom: 15px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    input, select, button {
      font-size: 16px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    select {
      min-width: 200px;
      background-color: white;
      cursor: pointer;
    }

    .payout-fieldset {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .payout-fieldset legend {
      font-weight: 600;
      color: #2c3e50;
      padding: 0 10px;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      font-weight: normal;
      cursor: pointer;
      margin-bottom: 0;
    }

    .radio-group input[type="radio"] {
      width: auto;
      margin-right: 8px;
      margin-bottom: 0;
    }

    .card-row {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .card-row input, .card-row select {
      margin: 0;
    }

    .card-row input[name="cardName"] {
      flex: 2;
      min-width: 200px;
    }

    .card-row input[name="cardQuantity"] {
      width: 80px;
      text-align: center;
    }

    .card-row select {
      width: 100px;
    }

    .remove-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 6px;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }

    .remove-btn:hover {
      background: #c0392b;
    }

    .override-section {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .override-section label {
      color: #856404;
      font-weight: bold;
    }

    .override-input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .override-input-group input {
      max-width: 200px;
      border: 2px solid #ffc107;
    }

    .override-input-group input:focus {
      border-color: #ffb300;
      box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.2);
    }

    .override-help {
      font-size: 0.9em;
      color: #856404;
      font-style: italic;
    }

    .override-warning {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: 600;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin: 25px 0;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      min-width: 120px;
    }

    #add-card {
      background: #27ae60;
      color: white;
    }

    #add-card:hover {
      background: #219a52;
    }

    #estimate-trade {
      background: #3498db;
      color: white;
    }

    #estimate-trade:hover {
      background: #2980b9;
    }

    #submit-trade {
      background: #e67e22;
      color: white;
    }

    #submit-trade:hover {
      background: #d35400;
    }

    .image-upload-section {
      margin: 25px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 2px dashed #bdc3c7;
    }

    .image-upload-section input[type="file"] {
      border: none;
      background: none;
      padding: 0;
    }

    #imagePreview {
      max-width: 200px;
      margin-top: 15px;
      border: 2px solid #bdc3c7;
      border-radius: 8px;
      display: none;
    }

    #statusBar {
      margin: 25px 0;
      padding: 15px;
      border-radius: 8px;
      font-weight: 600;
      border-left: 4px solid #3498db;
      background: #ecf0f1;
      min-height: 50px;
      display: flex;
      align-items: center;
    }

    .trade-log-section {
      margin-top: 30px;
      padding-top: 25px;
      border-top: 2px solid #ecf0f1;
    }

    #tradeLog {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .log-entry {
      padding: 10px;
      margin: 8px 0;
      background: white;
      border-radius: 6px;
      border-left: 4px solid #3498db;
      font-family: 'Courier New', monospace;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .main-container {
        padding: 20px;
      }
      
      .card-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .card-row input, .card-row select {
        margin-bottom: 10px;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      button {
        min-width: auto;
      }
    }
  </style>
</head>
<body>
  <div class="testing-banner">
    üöß TESTING VERSION ACTIVE üöß
  </div>

  <div class="main-container">
    <h2>üí≥ Trade-In Cards</h2>
    
    <form id="trade-form">
      <div class="form-group">
        <label for="employeeName">Employee:</label>
        <select name="employeeName" id="employeeName" required>
          <option value="" disabled selected>Select Employee</option>
          <option value="Alex">Alex</option>
          <option value="Jamie">Jamie</option>
          <option value="Morgan">Morgan</option>
          <option value="Taylor">Taylor</option>
        </select>
      </div>

      <fieldset class="payout-fieldset">
        <legend>Payout Method:</legend>
        <div class="radio-group">
          <label><input type="radio" name="payoutMethod" value="store-credit" required> üè™ Store Credit</label>
          <label><input type="radio" name="payoutMethod" value="cash" required> üíµ Cash</label>
        </div>
      </fieldset>

      <div class="form-group">
        <label>Cards to Trade:</label>
        <div id="card-list">
          <div class="card-row">
            <input type="text" name="cardName" placeholder="Card Name" required />
            <input type="number" name="cardQuantity" placeholder="Qty" min="1" value="1" required />
            <select name="cardCondition" required>
              <option value="NM">NM (Near Mint)</option>
              <option value="LP">LP (Lightly Played)</option>
              <option value="MP">MP (Moderately Played)</option>
            </select>
            <button type="button" class="remove-btn" onclick="this.parentElement.remove()">‚úñ</button>
          </div>
        </div>
      </div>

      <div class="form-group override-section">
        <label for="overrideTotal">üí∞ Trade Override (Optional):</label>
        <div class="override-input-group">
          <input type="number" id="overrideTotal" name="overrideTotal" placeholder="0.00" min="0" max="10000" step="0.01" />
          <span class="override-help">Leave empty to use calculated value. Max: $10,000</span>
        </div>
      </div>

      <div class="button-group">
        <button type="button" id="add-card">‚ûï Add Card</button>
        <button type="button" id="estimate-trade">üìä Estimate</button>
        <button type="submit" id="submit-trade">‚úÖ Submit Trade</button>
      </div>

      <div class="image-upload-section">
        <label for="cardImage"><strong>üì∏ Upload Card Image (optional):</strong></label>
        <input type="file" id="cardImage" name="cardImage" accept="image/*" onchange="previewImage(event)" />
        <div id="imagePreviewContainer">
          <img id="imagePreview" src="" alt="Card preview" />
        </div>
      </div>
    </form>

    <div id="statusBar">
      Ready to process trades...
    </div>

    <div class="trade-log-section">
      <h3>üìã Trade Log</h3>
      <div id="tradeLog">
        <p><em>Trade results will appear here...</em></p>
      </div>
    </div>
  </div>

  <script>
    function previewImage(event) {
      const file = event.target.files[0];
      const preview = document.getElementById('imagePreview');
      
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        }
        reader.readAsDataURL(file);
      } else {
        preview.style.display = 'none';
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById('trade-form');
      const statusBar = document.getElementById('statusBar');
      const addCardButton = document.getElementById('add-card');
      const cardList = document.getElementById('card-list');
      const estimateButton = document.getElementById('estimate-trade');

      // Add card functionality
      if (addCardButton && cardList) {
        addCardButton.addEventListener('click', () => {
          const cardRow = document.createElement('div');
          cardRow.className = 'card-row';
          cardRow.innerHTML = `
            <input type="text" name="cardName" placeholder="Card Name" required />
            <input type="number" name="cardQuantity" placeholder="Qty" min="1" value="1" required />
            <select name="cardCondition" required>
              <option value="NM">NM (Near Mint)</option>
              <option value="LP">LP (Lightly Played)</option>
              <option value="MP">MP (Moderately Played)</option>
            </select>
            <button type="button" class="remove-btn" onclick="this.parentElement.remove()">‚úñ</button>
          `;
          cardList.appendChild(cardRow);
        });
      }

      // Helper function to collect card data
      function collectCardData() {
        const cardRows = Array.from(document.querySelectorAll('.card-row'));
        const cards = [];

        cardRows.forEach(row => {
          const cardNameInput = row.querySelector('input[name="cardName"]');
          const quantityInput = row.querySelector('input[name="cardQuantity"]');
          const conditionSelect = row.querySelector('select[name="cardCondition"]');
          
          const cardName = cardNameInput?.value?.trim() || '';
          const quantity = quantityInput ? parseInt(quantityInput.value || "1", 10) : 1;
          const condition = conditionSelect?.value || 'NM';

          if (cardName && quantity > 0) {
            cards.push({ cardName, quantity, condition });
          }
        });

        return cards;
      }

      // Helper function to get override total
      function getOverrideTotal() {
        const overrideInput = document.getElementById('overrideTotal');
        const value = overrideInput?.value?.trim();
        
        if (!value || value === '') {
          return null;
        }
        
        const override = parseFloat(value);
        if (isNaN(override)) {
          throw new Error('Override total must be a valid number');
        }
        
        if (override < 0) {
          throw new Error('Override total cannot be negative');
        }
        
        if (override > 10000) {
          throw new Error('Override total exceeds maximum allowed limit ($10,000)');
        }
        
        return override;
      }

      // Helper function to update status
      function updateStatus(message, color = 'black') {
        statusBar.textContent = message;
        statusBar.style.color = color;
        statusBar.style.borderLeftColor = color;
      }

      // Helper function to display trade results
      function displayTradeResults(data, isEstimate = false) {
        const tradeLog = document.getElementById('tradeLog');
        let retailTotal = 0;

        if (Array.isArray(data.results) && data.results.length > 0) {
          tradeLog.innerHTML = '';
          
          data.results.forEach(result => {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            const safePrice = isNaN(parseFloat(result.retailPrice)) ? 0 : parseFloat(result.retailPrice);
            const totalValue = safePrice * result.quantity;
            
            logEntry.innerHTML = `
              <strong>${result.cardName}</strong><br>
              ${result.sku ? `SKU: ${result.sku} | ` : ''}
              Condition: ${result.condition || 'N/A'} | 
              Unit Price: $${safePrice.toFixed(2)} | 
              Quantity: ${result.quantity} | 
              Total: $${totalValue.toFixed(2)}
            `;
            
            tradeLog.appendChild(logEntry);
            retailTotal += totalValue;
          });
        } else {
          tradeLog.innerHTML = '<p><em>No matching cards found.</em></p>';
        }

        const actionText = isEstimate ? "Estimate complete!" : "Trade submitted successfully!";
        const valueText = isEstimate ? "Estimated Trade Value" : "Trade Payout";
        
        let status = `${actionText} | Items Value: $${parseFloat(data.totalRetailValue || retailTotal).toFixed(2)}`;
        
        // Show calculated vs final amount
        if (data.calculatedTotal) {
          status += ` | Calculated: $${parseFloat(data.calculatedTotal).toFixed(2)}`;
        }
        
        status += ` | ${valueText}: $${parseFloat(data.finalPayout || data.total || 0).toFixed(2)}`;

        // Show override information
        if (data.overrideUsed && !isEstimate) {
          const overrideDiff = parseFloat(data.overrideDifference || 0);
          const diffText = overrideDiff >= 0 ? `+$${overrideDiff.toFixed(2)}` : `-$${Math.abs(overrideDiff).toFixed(2)}`;
          status += ` | üîß OVERRIDE APPLIED (${diffText})`;
          
          // Add override warning to the log
          const overrideWarning = document.createElement('div');
          overrideWarning.className = 'override-warning';
          overrideWarning.innerHTML = `
            <strong>‚ö†Ô∏è Trade Override Applied</strong><br>
            Original Calculated Total: $${data.calculatedTotal}<br>
            Override Amount: $${data.overrideAmount}<br>
            Difference: ${diffText}
          `;
          tradeLog.insertBefore(overrideWarning, tradeLog.firstChild);
        }

        if (data.giftCardCode && !isEstimate) {
          status += ` | üéÅ Gift Card Code: ${data.giftCardCode}`;
        }

        updateStatus(status, isEstimate ? '#3498db' : '#27ae60');
      }

      // Estimate trade functionality
      if (estimateButton) {
        estimateButton.addEventListener('click', function () {
          const cards = collectCardData();
          
          if (cards.length === 0) {
            updateStatus('Please add at least one card to estimate.', '#e74c3c');
            return;
          }

          // Check for override in estimate mode
          try {
            const overrideTotal = getOverrideTotal();
            if (overrideTotal !== null) {
              updateStatus('Override total not allowed in estimate mode.', '#e74c3c');
              return;
            }
          } catch (error) {
            updateStatus(error.message, '#e74c3c');
            return;
          }

          const employeeName = document.getElementById('employeeName')?.value || '';
          const payoutMethod = document.querySelector('input[name="payoutMethod"]:checked')?.value || 'cash';

          updateStatus('Calculating estimate...', '#f39c12');

          fetch("/api/buybackstep4?estimate=true", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ employeeName, payoutMethod, cards })
          })
          .then(res => res.json())
          .then(data => {
            if (data.error) {
              updateStatus(`Error: ${data.error}`, '#e74c3c');
            } else {
              displayTradeResults(data, true);
            }
          })
          .catch(err => {
            console.error("Error estimating trade:", err);
            updateStatus('Error calculating estimate. Please try again.', '#e74c3c');
          });
        });
      }

      // Submit trade functionality
      if (form && statusBar) {
        form.addEventListener('submit', function (e) {
          e.preventDefault();
          
          const cards = collectCardData();
          
          if (cards.length === 0) {
            updateStatus('Please add at least one card to trade.', '#e74c3c');
            return;
          }

          // Validate override total
          let overrideTotal = null;
          try {
            overrideTotal = getOverrideTotal();
          } catch (error) {
            updateStatus(error.message, '#e74c3c');
            return;
          }

          // Show override confirmation if override is being used
          let confirmMessage = "Are you sure you want to submit this trade?";
          if (overrideTotal !== null) {
            confirmMessage = `‚ö†Ô∏è TRADE OVERRIDE DETECTED ‚ö†Ô∏è\n\nYou are overriding the calculated trade value with $${overrideTotal.toFixed(2)}.\n\nAre you sure you want to proceed with this override?`;
          }

          if (!confirm(confirmMessage)) return;

          updateStatus('Processing trade...', '#f39c12');

          const employeeName = document.getElementById('employeeName')?.value || '';
          const payoutMethod = document.querySelector('input[name="payoutMethod"]:checked')?.value || 'cash';

          const requestBody = { employeeName, payoutMethod, cards };
          if (overrideTotal !== null) {
            requestBody.overrideTotal = overrideTotal;
          }

          fetch("/api/buybackstep4", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestBody)
          })
          .then(res => res.json())
          .then(data => {
            if (data.error) {
              updateStatus(`Error: ${data.error}`, '#e74c3c');
            } else {
              displayTradeResults(data, false);
              // Clear form after successful submission
              form.reset();
              document.getElementById('imagePreview').style.display = 'none';
            }
          })
          .catch(err => {
            console.error("Error submitting trade:", err);
            updateStatus('Error submitting trade. Please try again.', '#e74c3c');
          });
        });
      }
    });
  </script>
</body>
</html>
